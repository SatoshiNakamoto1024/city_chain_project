# D:\city_chain_project\.github\workflows\ci.yml
name: BuildÂ &Â Test (RustÂ +Â PythonÂ wheels)

on:
  push:
    paths:
      - 'DAGs/libs/algorithm/**'
      - '.github/workflows/ci.yml'
  pull_request:
    paths:
      - 'DAGs/libs/algorithm/**'
      - '.github/workflows/ci.yml'

jobs:
  build-test-all:
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false          # â†“ å€‹åˆ¥ã‚¯ãƒ¬ãƒ¼ãƒˆã®å¤±æ•—ã§å…¨éƒ¨æ­¢ã‚ãªã„
      matrix:
        crate:
          - rvh_trace_rust       # ã“ã“ã¸è¿½åŠ ã™ã‚Œã°è‡ªå‹•ã§æ¨ªå±•é–‹
          # - poh_ack_rust
          # - dpos_rust
          # - pop_rust
          # - etc...

    # ä»¥é™ã® `run:` ã§ã®ç›¸å¯¾ãƒ‘ã‚¹åŸºæº–ã‚’ã‚¯ãƒ¬ãƒ¼ãƒˆç›´ä¸‹ã«å›ºå®š
    defaults:
      run:
        working-directory: ${{ github.workspace }}/DAGs/libs/algorithm/${{ matrix.crate }}

    steps:
      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¥Â Checkout repository
        uses: actions/checkout@v4

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¦Â CacheÂ CargoÂ registryÂ &Â target
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo-

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ”§Â SetÂ upÂ RustÂ 1.88Â (MSRV)
        uses: actions-rs/toolchain@v1
        with:
          toolchain: 1.88.0      # â† MSRV ã‚’å›ºå®š
          override: true

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸÂ SetÂ upÂ PythonÂ 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ğŸ©ºÂ InstallÂ systemÂ PythonÂ headers
        run: sudo apt-get update -y && sudo apt-get install -y python3.12-dev

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: â¬†ï¸Â UpgradeÂ pipÂ /Â installÂ maturin
        run: |
          python -m pip install --upgrade pip
          pip install maturin==1.5.1        # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã¯å›ºå®šæ¨å¥¨

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ§ªÂ CargoÂ buildÂ &Â testsÂ (release)
        run: |
          # ã‚¯ãƒ¬ãƒ¼ãƒˆå˜ä½“ãƒ“ãƒ«ãƒ‰ã§ã‚‚ workspace ä¾å­˜ã¯å…¨éƒ¨å–ã£ã¦ãã‚‹
          cargo test --workspace --all-targets --release -- --nocapture

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ—ï¸Â BuildÂ abi3Â wheel
        run: |
          maturin build \
            --release \
            --strip \
            -i python3.12 \
            --compatibility abi3 \
            --features py-ext \        # â†â˜…ã“ã“ï¼
            -o wheelhouse

      # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ğŸ“¤Â UploadÂ wheelÂ artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.crate }}-wheel
          path: wheelhouse/*.whl
