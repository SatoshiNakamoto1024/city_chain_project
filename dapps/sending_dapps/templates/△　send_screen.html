<!-- dapps\sending_dapps\templates\send_screen.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>送信用 DApp</title>
    <style>
        body{font-family:Arial,Helvetica,sans-serif;margin:40px}
        h1{margin-bottom:24px}
        label{display:inline-block;width:200px;margin-bottom:10px}
        input,textarea,select{padding:6px;width:300px;margin-bottom:10px}
        button{padding:8px 16px;background:#4CAF50;border:none;color:#fff;cursor:pointer}
        button:hover{background:#45a049}
        #message{margin-top:20px;font-weight:bold;color:red}
        /* Attributes */
        .attribute-pair{display:flex;align-items:center;margin-bottom:8px}
        .attribute-pair input{flex:1;margin-right:8px}
        .remove-attribute{background:#f44336}
        .remove-attribute:hover{background:#d32f2f}
        #add-attribute{background:#008CBA}
        #add-attribute:hover{background:#0071a3}
        /* 決算書 */
        table{width:100%;border-collapse:collapse;margin-bottom:24px}
        th,td{border:1px solid #ddd;padding:12px;text-align:left}
        th{background:#f2f2f2}
    </style>
</head>
<body>
<h1>送信用 DApp</h1>

<!-- ユーザー情報（テンプレート埋め込み） -->
<p>ウォレット: <b>{{ wallet_address|default('unknown') }}</b><br>
現在残高 : <b>{{ balance|default('0.00') }}</b> 愛貨</p>

<!-- ---------- 送信フォーム ---------- -->
<div id="transaction-form">
    <h2>トランザクションを作成</h2>

    <label for="sender">送信者名:</label>
    <input type="text" id="sender"><br>

    <label for="receiver">受信者名:</label>
    <input type="text" id="receiver"><br>

    <label for="amount">金額:</label>
    <input type="number" id="amount" step="0.01"><br>

    <label for="sender_municipality">送信者の市町村:</label>
    <input type="text" id="sender_municipality"><br>

    <label for="receiver_municipality">受信者の市町村:</label>
    <input type="text" id="receiver_municipality"><br>

    <!-- 任意フィールド -->
    <label for="message">メッセージ:</label>
    <textarea id="message_field" rows="3"></textarea><br>

    <!-- Attributes -->
    <h3>Attributes</h3>
    <div id="attributes-container">
        <div class="attribute-pair">
            <input type="text" class="attribute-key" placeholder="キー">
            <input type="text" class="attribute-value" placeholder="値">
            <button type="button" class="remove-attribute">削除</button>
        </div>
    </div>
    <button type="button" id="add-attribute">Attribute を追加</button><br><br>

    <button id="send-button">送信する</button>
    <div id="message"></div>
</div>

<!-- ---------- 決算書表示 ---------- -->
<div id="financial-statements" style="display:none;">
    <h2>決算書 (<span id="statement-date"></span>)</h2>

    <h3>貸借対照表</h3>
    <table>
        <tr><th>科目</th><th>金額</th></tr>
        <tr><td>資産合計</td><td id="assets-total"></td></tr>
        <tr><td>負債合計</td><td id="liabilities-total"></td></tr>
        <tr><td>純資産合計</td><td id="equity-total"></td></tr>
    </table>

    <h3>損益計算書</h3>
    <table>
        <tr><th>科目</th><th>金額</th></tr>
        <tr><td>収益合計</td><td id="revenue-total"></td></tr>
        <tr><td>費用合計</td><td id="expenses-total"></td></tr>
        <tr><td>純利益</td><td id="net-profit"></td></tr>
    </table>
</div>

<script>
/* ───────── JWT 取得 ───────── */
const jwt = localStorage.getItem('jwt_token');
if(!jwt){
    alert('未ログインです。ログインページへ移動します'); 
    location.href='/login';
}

/* ───────── Attributes UI ───────── */
document.getElementById('add-attribute').addEventListener('click',()=>{
    const div=document.createElement('div');
    div.className='attribute-pair';
    div.innerHTML=`
        <input type="text" class="attribute-key" placeholder="キー">
        <input type="text" class="attribute-value" placeholder="値">
        <button type="button" class="remove-attribute">削除</button>`;
    document.getElementById('attributes-container').appendChild(div);
});
document.getElementById('attributes-container').addEventListener('click',e=>{
    if(e.target.classList.contains('remove-attribute')){
        e.target.parentElement.remove();
    }
});

/* ───────── 送信ボタン ───────── */
document.getElementById('send-button').addEventListener('click',async()=>{
    const msgEl = document.getElementById('message');
    msgEl.textContent='';

    const data={
        sender:              document.getElementById('sender').value.trim(),
        receiver:            document.getElementById('receiver').value.trim(),
        amount:              document.getElementById('amount').value.trim(),
        sender_municipality: document.getElementById('sender_municipality').value.trim(),
        receiver_municipality:document.getElementById('receiver_municipality').value.trim(),
        message:             document.getElementById('message_field').value.trim(),
        // ダミー値（バックエンドで必須のフィールドを埋める）
        sender_wallet:   'dummy_sender_wallet',
        receiver_wallet: 'dummy_receiver_wallet',
        verifiable_credential:'dummy',
        subject:'send',
        action_level:'normal',
        dimension:'local',
        fluctuation:'none',
        organism_name:'-',
        details:'-',
        goods_or_money:'money',
        location:'-',
        proof_of_place:'-',
        attributes:{}
    };

    // Attributes 収集
    document.querySelectorAll('.attribute-pair').forEach(p=>{
        const k=p.querySelector('.attribute-key').value.trim();
        const v=p.querySelector('.attribute-value').value.trim();
        if(k) data.attributes[k]=v;
    });

    // 簡易バリデーション
    if(!data.sender || !data.receiver || !data.amount){
        msgEl.textContent='必須フィールド未入力です'; return;
    }

    try{
        const res=await fetch('/send/api/send_transaction',{
            method:'POST',
            headers:{
                'Content-Type':'application/json',
                'Authorization':`Bearer ${jwt}`
            },
            body:JSON.stringify(data)
        });
        const body=await res.json();
        if(res.ok){
            msgEl.style.color='green';
            msgEl.textContent=`送信成功！ transaction_id=${body.transaction_id}`;
            fetchFinancial(body.sender_municipality||'');
        }else{
            msgEl.textContent=`エラー: ${body.error||'unknown'}`;
        }
    }catch(e){
        msgEl.textContent='通信エラー';
        console.error(e);
    }
});

/* ───────── 決算書取得 ───────── */
async function fetchFinancial(muni){
    try{
        const res=await fetch(`/send/api/financial_statements?municipality=${encodeURIComponent(muni)}`,{
            headers:{'Authorization':`Bearer ${jwt}`}
        });
        if(!res.ok) return;
        const d=await res.json();
        document.getElementById('financial-statements').style.display='';
        document.getElementById('statement-date').textContent=d.date;
        document.getElementById('assets-total').textContent    = d.financial_data.assets.toFixed(2);
        document.getElementById('liabilities-total').textContent=d.financial_data.liabilities.toFixed(2);
        document.getElementById('equity-total').textContent    = d.financial_data.equity.toFixed(2);
        document.getElementById('revenue-total').textContent   = d.financial_data.revenue.toFixed(2);
        document.getElementById('expenses-total').textContent  = d.financial_data.expenses.toFixed(2);
        document.getElementById('net-profit').textContent      = d.financial_data.net_profit.toFixed(2);
    }catch(e){console.error(e);}
}
</script>
</body>
</html>
