<!-- admin/templates/dashboard.html -->
<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<title>Admin Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body{padding-top:4rem} .token-alert{word-break:break-all}
</style>
</head>
<body class="container">
<h1 class="mb-4">Admin Dashboard</h1>

<!-- JWT 入力欄（簡易デモ用）-->
<div class="mb-4">
  <label class="form-label">Admin JWT</label>
  <textarea id="jwt" class="form-control" rows="3"
            placeholder="ここに Bearer トークンを貼り付けて下さい"></textarea>
  <div class="form-text">※ JS fetch はこの値を Authorization ヘッダーに付加します</div>
</div>

<div class="alert alert-secondary token-alert d-none" id="tokendebug"></div>

<!-- シンプルなナビ -->
<ul class="nav nav-tabs mb-3" id="tabs">
  <li class="nav-item"><a class="nav-link active" data-target="sec-revoke" href="#">証明書失効</a></li>
  <li class="nav-item"><a class="nav-link"          data-target="sec-lock"   href="#">ユーザーロック</a></li>
  <li class="nav-item"><a class="nav-link"          data-target="sec-logs"   href="#">監査ログ</a></li>
</ul>

<!-- 1) 証明書失効 -->
<section id="sec-revoke">
  <h2 class="h4 mb-3">証明書失効</h2>
  <form id="form-revoke" class="row gy-2 gx-3 align-items-center">
    <div class="col-auto">
      <label class="visually-hidden">UUID</label>
      <input type="text" class="form-control" id="revoke-uuid" placeholder="User UUID">
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-danger">Revoke</button>
    </div>
  </form>
  <pre class="mt-3" id="revoke-result"></pre>
</section>

<!-- 2) ユーザーロック -->
<section id="sec-lock" class="d-none">
  <h2 class="h4 mb-3">ユーザーロック / 解除</h2>
  <form id="form-lock" class="row gy-2 gx-3 align-items-center">
    <div class="col-auto">
      <input type="text" class="form-control" id="lock-uuid" placeholder="User UUID">
    </div>
    <div class="col-auto">
      <button data-mode="lock"   type="submit" class="btn btn-warning">Lock</button>
      <button data-mode="unlock" type="submit" class="btn btn-success">Unlock</button>
    </div>
  </form>
  <pre class="mt-3" id="lock-result"></pre>
</section>

<!-- 3) 監査ログ -->
<section id="sec-logs" class="d-none">
  <h2 class="h4 mb-3">監査ログ (最新 100 件)</h2>
  <button id="btn-fetch-logs" class="btn btn-outline-primary mb-2">Refresh</button>
  <pre id="logs-result" style="max-height:40vh;overflow:auto;background:#f8f9fa" class="p-3"></pre>
</section>

<script>
const base = location.origin + "/admin";   // API ベース

// --- タブ切替
document.querySelectorAll("#tabs a").forEach(a=>{
  a.onclick=e=>{
    e.preventDefault();
    document.querySelectorAll("#tabs a").forEach(x=>x.classList.remove("active"));
    a.classList.add("active");
    document.querySelectorAll("section").forEach(s=>s.classList.add("d-none"));
    document.getElementById(a.dataset.target).classList.remove("d-none");
  }
});

// --- fetch 共通
function api(path, method="GET", body=null){
  const jwt = document.getElementById("jwt").value.trim();
  if(!jwt){alert("JWT を入力してください");throw "";}

  document.getElementById("tokendebug").classList.remove("d-none");
  document.getElementById("tokendebug").textContent = jwt;

  return fetch(base+path,{
    method,
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer "+jwt
    },
    body: body? JSON.stringify(body): null
  }).then(r=>r.json());
}

// --- revoke
document.getElementById("form-revoke").onsubmit = e=>{
  e.preventDefault();
  const uuid = document.getElementById("revoke-uuid").value.trim();
  api("/revoke_cert","POST",{uuid}).then(j=>{
    document.getElementById("revoke-result").textContent = JSON.stringify(j,null,2);
  });
};

// --- lock / unlock
document.getElementById("form-lock").onclick = e=>{
  if(e.target.tagName!=="BUTTON")return;
  e.preventDefault();
  const uuid = document.getElementById("lock-uuid").value.trim();
  const mode = e.target.dataset.mode;
  api("/"+(mode==="lock"?"lock_user":"unlock_user"),"POST",{uuid}).then(j=>{
    document.getElementById("lock-result").textContent = JSON.stringify(j,null,2);
  });
};

// --- logs
document.getElementById("btn-fetch-logs").onclick=()=>{
  api("/audit_logs?limit=100").then(j=>{
    document.getElementById("logs-result").textContent = JSON.stringify(j,null,2);
  });
};
</script>
</body>
</html>
