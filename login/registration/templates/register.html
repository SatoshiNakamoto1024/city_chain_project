<!-- registraion/templates/register.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f7f7f7;
      text-align: center;
      margin: 0;
      padding: 0;
    }
    .container {
      width: 90%;
      max-width: 400px;
      margin: 50px auto;
      background: #fff;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    form {
      display: flex;
      flex-direction: column;
      text-align: left;
    }
    label {
      margin-top: 10px;
      display: block;
    }
    input {
      padding: 8px;
      margin-top: 5px;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      margin-top: 20px;
      padding: 10px;
      background-color: #007bff;
      color: #fff;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #0056b3;
    }
    .back-button {
      margin-top: 10px;
      background-color: #aaa;
    }
    .back-button:hover {
      background-color: #888;
    }
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .modal {
      display: none; 
      position: fixed; 
      z-index: 1000; 
      left: 0;
      top: 0;
      width: 100%; 
      height: 100%; 
      overflow: auto; 
      background-color: rgba(0,0,0,0.5); 
    }
    .modal-content {
      background-color: #fff;
      margin: 15% auto; 
      padding: 20px;
      border: 1px solid #888;
      width: 80%; 
      max-width: 400px;
      text-align: left;
    }
    .modal-content label {
      margin-top: 10px;
    }
  </style>
  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
</head>
<body>
  <div class="container">
    <h1>ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²</h1>
    <!-- é€šå¸¸ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ  (1å°ç›®ç”¨) -->
    <form id="register-form"
      action="http://localhost:5000/registration/"
      method="POST">
      <label for="username">ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</label>
      <input type="text" id="username" name="username" required>

      <label for="birth_date">ç”Ÿå¹´æœˆæ—¥:</label>
      <input type="date" id="birth_date" name="birth_date" required>

      <label for="address">ä½æ‰€:</label>
      <input type="text" id="address" name="address" required>

      <label for="mynumber">ãƒã‚¤ãƒŠãƒ³ãƒãƒ¼:</label>
      <input type="text" id="mynumber" name="mynumber" required>

      <label for="email">ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹:</label>
      <input type="email" id="email" name="email" required>

      <label for="phone">é›»è©±ç•ªå·:</label>
      <input type="text" id="phone" name="phone" required>

      <label for="password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
      <input type="password" id="password" name="password" required>

      <label for="initial_harmony_token">åˆæœŸHarmony Token:</label>
      <input type="number" id="initial_harmony_token" name="initial_harmony_token" required>

      <!-- éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼šQRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šã§è¨­å®šã•ã‚Œã‚‹ã€‚2å°ç›®ç™»éŒ²ç”¨ -->
      <input type="hidden" id="qr_code" name="qr_code">
      
      <button type="submit">ç™»éŒ²</button>
    </form>

    <!-- QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šç”¨ã®ã‚¨ãƒªã‚¢ï¼ˆé€šå¸¸ã¯è¡¨ç¤ºã•ã‚Œãªã„ï¼‰ -->
    <button type="button" onclick="enableQRScan()">ğŸ“· 2å°ç›®ä»¥é™ã®ç™»éŒ²ï¼ˆQRèª­ã¿å–ã‚Šï¼‰</button>
    <div id="qr-reader" style="width:300px; margin:auto; display:none;"></div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼š2å°ç›®ç™»éŒ²æ™‚ã®è¿½åŠ æœ¬äººç¢ºèªç”¨ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼åãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å†å…¥åŠ›ï¼‰ -->
    <div id="auth-modal" class="modal">
      <div class="modal-content">
        <h3>2å°ç›®ã®ç™»éŒ²ç¢ºèª</h3>
        <p>ç™»éŒ²æ¸ˆã¿ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å†å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚</p>
        <label for="modal-username">ãƒ¦ãƒ¼ã‚¶ãƒ¼å:</label>
        <input type="text" id="modal-username" name="modal-username" required>
        <label for="modal-password">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰:</label>
        <input type="password" id="modal-password" name="modal-password" required>
        <button type="button" onclick="submitSecondaryRegistration()">ç¢ºèªãƒ»ç™»éŒ²</button>
      </div>
    </div>

    <button class="back-button" onclick="window.location.href='/'">æˆ»ã‚‹</button>
  </div>

  <p>
    â€»ç™»éŒ²å¾Œã€ã‚·ã‚¹ãƒ†ãƒ å´ã§ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ï¼ˆ.p12ãƒ•ã‚¡ã‚¤ãƒ«ç›¸å½“ï¼‰ãŒç™ºè¡Œã•ã‚Œã¾ã™ã€‚<br>
    é«˜é½¢è€…å‘ã‘ã«ã¯ã€QRã‚³ãƒ¼ãƒ‰ã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«æ·»ä»˜ã§è¨¼æ˜æ›¸ã‚’é…å¸ƒã—ã¾ã™ã€‚
  </p>

  <script>
    // QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šèµ·å‹•
    function enableQRScan() {
      const qrReader = document.getElementById("qr-reader");
      qrReader.style.display = "block";
      const html5QrCode = new Html5Qrcode("qr-reader");
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText, decodedResult) => {
          // QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šå¾Œã€éš ã—ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å€¤ã‚’ã‚»ãƒƒãƒˆ
          document.getElementById("qr_code").value = decodedText;
          // è¡¨ç¤ºä¸­ã®QRã‚³ãƒ¼ãƒ‰èª­ã¿å–ã‚Šç”»é¢ã‚’éš ã™
          html5QrCode.stop().then(() => {
            qrReader.style.display = "none";
            // 2å°ç›®ç™»éŒ²ç”¨ã®èªè¨¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
            showAuthModal();
          }).catch(err => {
            console.error("QRã‚³ãƒ¼ãƒ‰åœæ­¢ã‚¨ãƒ©ãƒ¼:", err);
          });
        },
        (errorMessage) => {
          console.warn("èª­ã¿å–ã‚Šã‚¨ãƒ©ãƒ¼:", errorMessage);
        }
      ).catch(err => {
        console.error("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼:", err);
        alert("ã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚");
      });
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤ºåˆ¶å¾¡
    function showAuthModal() {
      document.getElementById("auth-modal").style.display = "block";
    }
    function hideAuthModal() {
      document.getElementById("auth-modal").style.display = "none";
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å†…å®¹ã‚’é€šå¸¸ãƒ•ã‚©ãƒ¼ãƒ ã®è©²å½“ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¸ã‚³ãƒ”ãƒ¼ã—ã¦ã€ãƒ•ã‚©ãƒ¼ãƒ ã‚’å†é€ä¿¡
    function submitSecondaryRegistration() {
      const modalUsername = document.getElementById("modal-username").value;
      const modalPassword = document.getElementById("modal-password").value;
      // ã‚»ã‚«ãƒ³ãƒ€ãƒªç™»éŒ²ã®å ´åˆã€QRã‚³ãƒ¼ãƒ‰ã§å–å¾—ã—ãŸæƒ…å ±ã«åŠ ãˆã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼èªè¨¼æƒ…å ±ã¨ã—ã¦ä¸Šæ›¸ã
      // ãŸã¨ãˆã°ã€ã™ã§ã«å…¥åŠ›æ¸ˆã¿ã®register-formã®usernameã¨passwordã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«ã‚»ãƒƒãƒˆã™ã‚‹
      document.getElementById("username").value = modalUsername;
      document.getElementById("password").value = modalPassword;
      hideAuthModal();
      // ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã‚’è‡ªå‹•é€ä¿¡ã™ã‚‹
      document.getElementById("register-form").dispatchEvent(new Event("submit", {cancelable: true}));
    }

    // ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ ã®é€ä¿¡å‡¦ç†
    document.getElementById("register-form").addEventListener("submit", function(e){
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = Object.fromEntries(formData.entries());
      fetch("/registration/", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
      })
      .then(response => response.json())
      .then(result => {
        if(result.success){
          alert("ç™»éŒ²æˆåŠŸï¼\nç™ºè¡Œã•ã‚ŒãŸã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã‚’å¿…ãšä¿å­˜ã—ã¦ãã ã•ã„ã€‚\nè¨¼æ˜æ›¸ã¯QRã‚³ãƒ¼ãƒ‰ã¾ãŸã¯ãƒ¡ãƒ¼ãƒ«ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¯èƒ½ã§ã™ã€‚");
          console.log("Client Certificate (Base64):", result.client_cert);
          window.location.href = "/login";
        } else {
          alert("ç™»éŒ²å¤±æ•—: " + (result.error || "ä¸æ˜ãªã‚¨ãƒ©ãƒ¼"));
        }
      })
      .catch(error => {
        console.error("Error:", error);
        alert("ç™»éŒ²ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚");
      });
    });
  </script>
</body>
</html>
