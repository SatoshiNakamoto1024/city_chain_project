# 2. login_app/app_login.py å´ã® login_bp ã¨ä½•ãŒé•ã†ã®ã‹ï¼Ÿ
app_login.py ã® login_bp
ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ç”»é¢ (HTML ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ) ã¨é€£å‹•ã—ã¦

/login/ ã® GET ã§ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ã‚©ãƒ¼ãƒ ã‚’è¿”ã—

/login/ ã® POST ã§ãƒ¯ãƒ³ã‚¿ã‚¤ãƒ èªè¨¼ã‚„ï¼’æ®µéšŽèªè¨¼ã‚’å«ã‚€ãƒ•ãƒ­ãƒ¼ã‚’åˆ¶å¾¡
ã¨ã„ã£ãŸã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘ã‘ Web ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æœ¬ä½“ã®ã€Œãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã€ã€Œãƒ­ã‚°ã‚¤ãƒ³ APIã€ã‚’æ‹…ã„ã¾ã™ã€‚

utils/login_handler.py (device_auth_bp)
IoT ã‚„ã‚²ãƒ¼ãƒ æ©Ÿã€TV ãªã©ã®**å¤–éƒ¨ç«¯æœ«ï¼ˆã‚¦ã‚§ãƒ–ç”»é¢ã‚’æŒãŸãªã„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆï¼‰**ãŒ

ç«¯æœ«ã®ç©ºãã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚’å ±å‘Šã—

ãƒ¦ãƒ¼ã‚¶ãƒ¼åï¼ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼è¨¼æ˜Žæ›¸æŒ‡ç´‹ã‚’ POST ã™ã‚‹
â€¦ã¨ã„ã£ãŸã€çµ„ã¿è¾¼ã¿ãƒ‡ãƒã‚¤ã‚¹å‘ã‘ã®è»½é‡èªè¨¼ï¼‹ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ãƒã‚§ãƒƒã‚¯ã«ç‰¹åŒ–ã—ãŸãƒžã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹çš„ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

ã¤ã¾ã‚Šã€

åå‰ã¯ä¼¼ã¦ã„ã¾ã™ãŒç”¨é€”ãŒç•°ãªã‚‹ï¼ˆä¸€æ–¹ã¯ãƒ–ãƒ©ã‚¦ã‚¶ç”»é¢+ãƒ•ã‚©ãƒ¼ãƒ ç”¨ã€ã‚‚ã†ä¸€æ–¹ã¯å¤–éƒ¨ç«¯æœ«ç”¨ APIï¼‰ã€‚

Blueprint åã‚„ URL ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’åˆ†ã‘ã¦ãŠã‘ã°ã€åŒã˜ã€Œlogin_bpã€ã¨ã„ã†åç§°è¡çªã‚‚èµ·ãã¾ã›ã‚“ã—ã€å‹•ã‹ã™ã‚µãƒ¼ãƒãƒ¼ã‚’åˆ†ã‘ã¦ã‚‚æ§‹ã„ã¾ã›ã‚“ã€‚

âœ… ã‚«ãƒ¼ãƒŠãƒ“ã‚„ã‚²ãƒ¼ãƒ æ©Ÿãƒ»IoTãƒ‡ãƒã‚¤ã‚¹ã§ä½¿ãˆã‚‹ã€Œãƒ¡ãƒ¢ãƒªçš„ã€ãªä¿å­˜æ–¹æ³•
æ‰‹æ®µ	å®Ÿç¾æ–¹æ³•ä¾‹	å®‰å…¨æ€§	ã‚³ãƒ¡ãƒ³ãƒˆ
å†…è”µ Flash/eMMC ã«ä¿å­˜	ã‚¢ãƒ—ãƒªã®å†…éƒ¨ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸é ˜åŸŸã«ãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜	â—‹	æœ€ã‚‚ç¾å®Ÿçš„ãªæ–¹å¼ã€‚ç›—é›£æ™‚æ³¨æ„
ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜	OSã®ãƒ–ãƒ¼ãƒˆæ™‚ã«ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦èª­ã¿è¾¼ã‚€	â–³	ä¸€æ™‚çš„ã§å†èµ·å‹•ã§æ¶ˆãˆã‚‹
EEPROMã«ä¿å­˜	å°‘é‡ã®éµã‚’ãƒã‚¤ãƒŠãƒªã§ä¿å­˜å¯èƒ½	â—‹ã€œâ—Ž	å®¶é›»ã‚„ã‚»ãƒ³ã‚µãƒ¼ã§åˆ©ç”¨å¯
Web Storageç³»ï¼ˆPWAï¼‰	WebViewã‚¢ãƒ—ãƒªãªã‚‰ IndexedDB ã‚„ Cache API	â—‹	ã‚¹ãƒžãƒ¼ãƒˆTVã‚„ã‚¹ãƒžãƒ¼ãƒˆå®¶é›»

âœ… é¸æŠžè‚¢ï¼šãƒ‡ã‚£ã‚¹ã‚¯ä»¥å¤–ã«ä¿å­˜ã§ãã‚‹å ´æ‰€ï¼ˆç«¯æœ«åˆ¥ï¼‰
ä¿å­˜å…ˆ	å±¤	ç‰¹å¾´	å¯¾è±¡ç«¯æœ«ã®ä¾‹
RAM	æ®ç™ºæ€§	ä¸€æ™‚çš„ãªè¨˜æ†¶ã€é›»æºOFFã§æ¶ˆãˆã‚‹	ä¸€æ™‚ç½²åå‡¦ç†ã§æœ‰åŠ¹
Flash (eMMC/NAND)	æ°¸ç¶šçš„	å†…è”µã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã€HDD/SSDã®ä»£æ›¿	IoTãƒ»ã‚¹ãƒžãƒ¼ãƒˆã‚¹ãƒ”ãƒ¼ã‚«ãƒ¼ç­‰
Secure Element (SE)	ãƒãƒ¼ãƒ‰	æš—å·éµç”¨å°‚ç”¨ãƒãƒƒãƒ—ï¼ˆéµç„¼ãè¾¼ã¿å¯ï¼‰	ã‚«ãƒ¼ãƒŠãƒ“ãƒ»ã‚²ãƒ¼ãƒ æ©Ÿãƒ»è»Šè¼‰ç«¯æœ«
TPM / HSM	ãƒãƒ¼ãƒ‰	æš—å·è¨ˆç®—å°‚ç”¨ã€å®‰å…¨ãªéµæ ¼ç´	ä¸€éƒ¨ã®é«˜ç´šPCãƒ»æ³•äººIoT
EEPROM	ãƒãƒ¼ãƒ‰	å°‘é‡ã®ãƒ‡ãƒ¼ã‚¿ã‚’æ°¸ç¶šä¿å­˜ï¼ˆæ•°KBç¨‹åº¦ï¼‰	å®¶é›»ãƒ»ã‚»ãƒ³ã‚µãƒ¼
Firmwareé ˜åŸŸ	ã‚½ãƒ•ãƒˆ/ROM	ã‚½ãƒ•ãƒˆçš„ã«éµã‚’åŸ‹ã‚è¾¼ã¿ï¼ˆã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆé›£ï¼‰	å·¥å ´å‡ºè·æ™‚å›ºå®šã‚­ãƒ¼ç­‰

login/
 â””â”€ user_manager/
     â””â”€ utils/
         â”œâ”€ platform_utils.py
         â”œâ”€ storage_checker.py
         â”œâ”€ login_handler.py
         â””â”€ test_utils.py
 â””â”€ client_code/
     â”œâ”€ pc_check.py
     â”œâ”€ android_check.kt
     â”œâ”€ ios_check.swift
     â”œâ”€ game_check.c
     â””â”€ README.md (ä»»æ„ã§è¿½åŠ ã®èª¬æ˜Žã‚’å…¥ã‚Œã¦ã‚‚è‰¯ã„)

# Client Code for Storage Checking

å„ç«¯æœ«ã”ã¨ã«å®Ÿè£…ä¾‹ã‚’ã¾ã¨ã‚ãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§ã™ã€‚

- **pc_check.py**:  
  Windows/Mac/Linux PC ã§ Python ã‚’ä½¿ã„ã€`shutil.disk_usage` ã«ã‚ˆã‚Šç©ºãå®¹é‡ã‚’è¨ˆç®— â†’ ã‚µãƒ¼ãƒãƒ¼ã¸POSTã€‚

- **android_check.kt**:  
  Kotlin ã§ `StatFs` ã‚’ä½¿ã„ã€ã‚¢ãƒ—ãƒªå†…éƒ¨é ˜åŸŸã®ç©ºãå®¹é‡ (bytes) ã‚’å–å¾— â†’ OkHttp ã§ã‚µãƒ¼ãƒãƒ¼ã¸POSTã€‚

- **ios_check.swift**:  
  Swift ã§ `FileManager` ã‚„ `resourceValues(volumeAvailableCapacityForImportantUsageKey)` ã‚’ä½¿ã„ç©ºãå®¹é‡ã‚’å–å¾— â†’ `URLSession` ã§ã‚µãƒ¼ãƒãƒ¼ã¸POSTã€‚

- **game_check.c**:  
  Linuxç³»ã® statvfs ã«ã‚ˆã‚Šç©ºãå®¹é‡ã‚’å–å¾— â†’ libcurl ã§ JSON POSTã€‚
  ï¼ˆPlayStation, Xbox, Switch ç­‰ å…¬å¼SDK ã§ã¯æ‰‹æ³•ãŒç•°ãªã‚‹å ´åˆãŒå¤šã„ã®ã§ã‚«ã‚¹ã‚¿ãƒžã‚¤ã‚ºãŒå¿…è¦ï¼‰

## How to Use

1. ãã‚Œãžã‚Œã®ç«¯æœ«ä¸Šã§ã€å¯¾å¿œã™ã‚‹ã‚³ãƒ¼ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰ / å®Ÿè¡Œã€‚  
2. ã‚µãƒ¼ãƒãƒ¼ (Flask) å´ã¯ `login_handler.py` ã‚’èµ·å‹•ã—ã¦ãŠãã€‚  
3. ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒé€ã‚‹ `client_free_space` (ãƒã‚¤ãƒˆæ•°) ã‚’ã‚‚ã¨ã«ã€ã‚µãƒ¼ãƒãƒ¼ãŒ 100MB ä»¥ä¸Šã‹åˆ¤å®šã€‚  
4. OK ãªã‚‰ 200ã€è¶³ã‚Šãªã‘ã‚Œã° 403 ã‚’è¿”ã™ã€‚  

## Note

- æœ¬ä¾‹ã§ã¯ãƒ‡ãƒ¢ç”¨ã«èªè¨¼ã‚’ãƒ€ãƒŸãƒ¼å®Ÿè£… (admin/password) ã¨ã—ã¦ã„ã‚‹ãŒã€æœ¬ç•ªã§ã¯ã‚»ã‚­ãƒ¥ã‚¢ãªèªè¨¼æ‰‹æ³•ã‚’é©ç”¨ã—ã¦ãã ã•ã„ã€‚  
- å®Ÿéš›ã®ã‚²ãƒ¼ãƒ æ©Ÿã‚„ã‚¹ãƒžãƒ›ã§ã¯ã‚µãƒ¼ãƒãƒ¼ã¨åŒå±…ã—ãªã„ã“ã¨ãŒå¤šã„ãŸã‚ã€ãƒ­ãƒ¼ã‚«ãƒ«ã§ã® ctypes å‘¼ã³å‡ºã—ã¯è¡Œã‚ãšã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã®ãƒã‚¤ãƒ†ã‚£ãƒ– API ã§ç©ºãå®¹é‡ã‚’å–å¾—ã™ã‚‹ã®ãŒé€šä¾‹ã§ã™ã€‚

# test
test_utils.py ã¯ã€ã‚ãã¾ã§ login_handler.py ã‚’èµ·å‹•ã—ã¦ãã“ã«å¯¾ã—ã¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æŠ•ã’ã‚‹ã ã‘ã®ãƒ†ã‚¹ãƒˆã§ã™ã€‚ã§ã™ã®ã§ã€äº‹å‰ã«ç«‹ã¡ä¸Šã’ã¦ãŠãã¹ãã€Œã‚µãƒ¼ãƒãƒ¼ã€ã¯ login_handler.py ã ã‘ã§ã™ã€‚ä»¥ä¸‹ã®è¦ç‚¹ã‚’æŠ¼ã•ãˆã¦ãã ã•ã„ã€‚
(.venv312) D:\city_chain_project\login\user_manager\utils>python login_handler.py
[INFO] ca_issue_client_cert_asn1.py loaded
 * Serving Flask app 'login_handler'
 * Debug mode: on
[INFO] 2025-05-07 06:46:16,033 - [31m[1mWARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.[0m
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5050
 * Running on http://172.21.2.182:5050
[INFO] 2025-05-07 06:46:16,033 - [33mPress CTRL+C to quit[0m
[INFO] 2025-05-07 06:46:16,048 -  * Restarting with stat
[INFO] ca_issue_client_cert_asn1.py loaded
[WARNING] 2025-05-07 06:46:18,423 -  * Debugger is active!
[INFO] 2025-05-07 06:46:18,611 -  * Debugger PIN: 114-323-945


(.venv312) D:\city_chain_project\login\user_manager\utils>pytest -v test_utils.py
================================================= test session starts =================================================
platform win32 -- Python 3.12.10, pytest-8.3.5, pluggy-1.5.0 -- D:\city_chain_project\.venv312\Scripts\python.exe
cachedir: .pytest_cache
rootdir: D:\city_chain_project\login\user_manager\utils
collected 2 items

test_utils.py::TestLoginHandler::test_login_pc_storage_and_auth PASSED                                           [ 50%]
test_utils.py::TestLoginHandler::test_login_android_storage_and_auth PASSED                                      [100%]

================================================== 2 passed in 2.61s ==================================================
