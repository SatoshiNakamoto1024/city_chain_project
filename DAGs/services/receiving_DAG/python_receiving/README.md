# ã€Œã ã‚Œã‚‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„ãƒ©ã‚¤ãƒˆãƒŽãƒ¼ãƒ‰ã§ã‚‚ 500 ms ä»¥å†…ã«å¿…ãšå¾©å…ƒã—ãŸã„ã€
â”€â”€ ãã®ãŸã‚ã® 4 æ®µãƒ•ã‚§ã‚¤ãƒ«ã‚ªãƒ¼ãƒãƒ¼çµŒè·¯ ã¨ æŒ‡ä»¤ãƒ•ãƒ­ãƒ¼ ã‚’ 1 æžšã§ç†è§£ã™ã‚‹

å„ªå…ˆåº¦â‘         å„ªå…ˆåº¦â‘¡           å„ªå…ˆåº¦â‘¢              å„ªå…ˆåº¦â‘£
ã‚ªãƒ³ãƒ©ã‚¤ãƒ³LN â–¶ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³FN â–¶ Mongo Hot â–¶ Continent Router + immuDB
     50 ms          100 ms           300 ms                  1 s è¶…ã§ã‚‚å¯
è¨˜å·	æ‰€è¦é…å»¶(p95)	ä¸»ãªå‹•ã	èªè¨¼ & é˜²å¾¡
LN
ãƒ©ã‚¤ãƒˆãƒŽãƒ¼ãƒ‰	5â€“50 ms	ã‚·ãƒ£ãƒ¼ãƒ‰ k/ n & PoH_ACK ã‚’è¿”ã™	ç«¯æœ«è¨¼æ˜Žæ›¸ + Dilithium
FN
ãƒ•ãƒ«ãƒŽãƒ¼ãƒ‰	30â€“100 ms	RAM/SSD ã«æŒã¤ã€ŒTx ãƒ˜ãƒƒãƒ€ + Mongo ã‚­ãƒ¼ã€ã‹ã‚‰ç›´è¿”ã—	HSM / TLS mTLS
Mongo Hot	50â€“300 ms	FN ãŒç´¢å¼•ä»˜ã find({tx_id})	VPC + IP Allow + IAM
Continent Router	200â€“400 ms	åˆ¥ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ Mongo / immuDB ã‚’æ¤œç´¢ã—
RESCUE_BUNDLE ã‚’è¿‘æŽ¥ FN ã¸ãƒ—ãƒƒã‚·ãƒ¥	Geo-DNS + Anycast
è¨¼æ˜Žãƒãƒƒã‚·ãƒ¥

1. ãƒ©ã‚¤ãƒˆãƒŽãƒ¼ãƒ‰ãŒ 0 å°ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã ã£ãŸæ™‚ã®å¾©å…ƒã‚·ãƒ¼ã‚±ãƒ³ã‚¹
sequenceDiagram
  participant Req as Requesting LN
  participant FN  as City-FullNode
  participant DB  as Mongo Hot
  participant CTR as Continent Router
  participant FN2 as Remote FN
  participant IMMU as immuDB

  Req->>FN: REPAIR_REQ(tx_id) â‘ 
  alt ãƒ˜ãƒƒãƒ€å‘½ä¸­
      FN->>DB: find(tx_id) â‘¡
      DB-->>FN: {payload, sig}
      FN-->>Req: REPAIR_ACK â‘¢
  else City cluster dead
      Req->>CTR: ESCALATE_REQ â‘£
      CTR->>IMMU: query(tx_id)
      CTR-->>FN2: RESCUE_BUNDLE
      FN2-->>Req: REPAIR_ACK â‘¤
  end
ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ç›®æ¨™

ãƒ•ã‚§ãƒ¼ã‚º	ç›®æ¨™	å‚™è€ƒ
â‘  ãƒ­ãƒ¼ã‚«ãƒ« FN æ¤œå‡º	< 50 ms	â€œãƒ˜ãƒƒãƒ€ LRUâ€ ã« tx_idâ†’mongoKey
â‘¡ Mongo find	50â€“200 ms	tx_id ç´¢å¼• + WiredTiger cache
â‘¢ ç½²åå†ä»˜ä¸Ž + é€ä¿¡	< 30 ms	Dilithium 0.3 ms + gzip
åˆè¨ˆ(é€šå¸¸)	< 300 ms	500 ms ä»¥å†…ã«ä½™è£•
â‘£â€“â‘¤ (ãƒªãƒ¼ã‚¸ãƒ§ãƒ³éšœå®³)	300â€“600 ms	immu ã¯ Append-only â‡’ èª­ã¿è¾¼ã¿ 150 ms

2. ãªãœ Mongo Hot ã‚’ ãƒ•ãƒ«ãƒŽãƒ¼ãƒ‰ã¨ã¯ç‹¬ç«‹ ã‚¯ãƒ©ã‚¹ã‚¿ã«ã™ã‚‹ã®ã‹
ç†ç”±	ãƒ¡ãƒªãƒƒãƒˆ
æ°´å¹³ã‚¹ã‚±ãƒ¼ãƒ«å˜ä½ãŒé•ã†	TPS å¢—â†’ãƒ•ãƒ«ãƒŽãƒ¼ãƒ‰ vCPU ã‚’å¢—ã‚„ã™ã ã‘ã€‚
ãƒ‡ãƒ¼ã‚¿å¢—â†’Mongo ã‚·ãƒ£ãƒ¼ãƒ‰ã‚’è¿½åŠ ã™ã‚‹ã ã‘ã€‚
ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ†é›¢	Mongo ã¯ VPC å†…ã€FN ã‹ã‚‰ mTLS+IAM ã§ã—ã‹æ›¸ã‘ãªã„ã€‚ä¾µå®³é¢ã‚’é™å®šã€‚
éšœå®³ãƒ‰ãƒ¡ã‚¤ãƒ³åˆ†å‰²	FN è½ã¡ã¦ã‚‚ Mongo ã¯ç”Ÿãã¦ã„ã‚‹ â‡’ Router ã‹ã‚‰ç›´æŽ¥èª­ã‚ã‚‹ã€‚

3. Continent Router ã®å½¹å‰² = â€œæœ€å¾Œã® 1 æœ¬ã‚’æŽ¢ã™æ¤œç´¢ã‚¨ãƒ³ã‚¸ãƒ³â€
å„ City-FN ã¯ å®Œäº†ãƒãƒƒãƒã® Merkle-root ã‚’ Router ã«é€±æ¬¡ Push
â†’ Router ã¯ã€Œã©ã® Mongo ã‚·ãƒ£ãƒ¼ãƒ‰ or immuDB ã«åœ¨ã‚‹ã‹ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã ã‘ä¿æŒï¼ˆæ•° KBï¼‰

Escalate å—ä¿¡æ™‚
ãƒ«ãƒ¼ãƒˆâ†’è©²å½“ãƒãƒƒãƒâ†’è©²å½“ Tx ã® blobPtr ã‚’å³è¿”ã™
æœ€å¯„ã‚Šã®ç”Ÿå­˜ FN ã¸ RESCUE_BUNDLE (Tx + PoH) ã‚’ P2P Push
å…ƒã®ãƒ©ã‚¤ãƒˆãƒŽãƒ¼ãƒ‰ã¯ 1 RTT ã§å¾©å…ƒ
ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ RAM å¸¸é§ â‡’ 10 ms ä»¥å†…ã§ãƒ’ãƒƒãƒˆã€‚

4. ãƒãƒƒã‚­ãƒ³ã‚°ãƒªã‚¹ã‚¯å¯¾ç­–
ãƒªã‚¹ã‚¯, 	é˜²å¾¡
å½ REPAIR_REQ flood	FN ã§ â€œPoH æœ‰ç„¡ + èªè¨¼æ¸ˆã¿è¨¼æ˜Žæ›¸ CNâ€ ã‚’ç¢ºèªã— RateLimit
DB dump èª­ã¿å–ã‚Š, 	Mongo æš—å·åŒ– at-rest + VPC PrivateSubnet
Continent Router æ”»æ’ƒ, 	Anycast + eBPF DDoS scrubber + read-only key
ç½²åå½é€ , 	Dilithium + CA mTLSã€‚impossible w/o key.

5. å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ (City-FN è¦³ç‚¹)
ãƒ˜ãƒƒãƒ€ LRU
header_cache.put(tx_id, {"mongo_key":ObjectId, "poh_cnt":k})
REPAIR_REQ handler

header = cache.get(tx_id) â†’ hit ãªã‚‰ Mongo read

miss â†’ 404 ã‚’è¿”ã— Requesting LN ãŒ Escalate

Mongo ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³è¨­è¨ˆ
unfinished_{yyyymm}, ç´¢å¼• {tx_id:1}
finished_{yyyymm}, TTL index 180 d

Continent Router API
/rescue?tx_id= â†’ returns {region:"ap-northeast", mongo_uri:"â€¦"}


âœ… ã¾ã¨ã‚
é€šå¸¸ï¼šãƒ©ã‚¤ãƒˆãƒŽãƒ¼ãƒ‰ãŒã‚ªãƒ³ãƒ©ã‚¤ãƒ³ â†’ k/n ã‚·ãƒ£ãƒ¼ãƒ‰ã§ 50 msã€œ100 ms å¾©å…ƒ
å…¨ LN ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ï¼šãƒ•ãƒ«ãƒŽãƒ¼ãƒ‰ + MongoHot ãƒ«ãƒ¼ãƒˆ â†’ 200 msã€œ300 ms
City éšœå®³ï¼šContinent Router â†’ Remote FN + immuDB â†’ 400 msã€œ600 ms
å…¨ä¸–ç•Œéšœå®³ï¼šimmuDB ãƒ­ã‚°ã‹ã‚‰å†æ§‹ç¯‰ï¼ˆé€Ÿåº¦è¦æ±‚ãªã—ã€ç›£æŸ»ç”¨ï¼‰
ã“ã‚Œã§ã€Œèª°ã‚‚ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ã„ãªã„ãƒ©ã‚¤ãƒˆãƒŽãƒ¼ãƒ‰ã§ã‚‚ 500 ms ä»¥å†…ã«å¾©å…ƒã€ã¨ã„ã†ç›®æ¨™ã¨ã€ãƒãƒƒã‚­ãƒ³ã‚°è€æ€§ã®ä¸¡æ–¹ã‚’åŒæ™‚ã«æº€ãŸã›ã¾ã™ã€‚

ðŸ” æ™®æ®µï¼šãƒ©ã‚¤ãƒˆãƒŽãƒ¼ãƒ‰ã ã‘ã§æ¸ˆã‚€ï¼ˆè¶…é«˜é€Ÿï¼‰
ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¯ã€ãƒ©ã‚¤ãƒˆãƒŽãƒ¼ãƒ‰ï¼ˆã‚¹ãƒžãƒ›ã‚„IoTãªã©ï¼‰ã«åˆ†æ•£ã—ã¦ãƒ”ãƒ¼ã‚¹ã¨ã—ã¦ä¿å­˜ã•ã‚Œã‚‹ã€‚
å—ä¿¡è€…ãŒãƒ­ã‚°ã‚¤ãƒ³ã™ã‚‹ã¨ã€ãã®å ´ã§ãƒ”ãƒ¼ã‚¹ã‚’é›†ã‚ã¦æ•°åãƒŸãƒªç§’ã§å¾©å…ƒã§ãã‚‹ã€‚

ðŸ§¯ ã§ã‚‚ä¸‡ãŒä¸€ï¼š
ãƒ©ã‚¤ãƒˆãƒŽãƒ¼ãƒ‰ãŒå…¨å“¡ã‚ªãƒ•ãƒ©ã‚¤ãƒ³ã ã£ãŸã‚Šã€ãƒ‡ãƒ¼ã‚¿ãŒå£Šã‚Œã¦ã„ã¦ã‚‚â€¦

âœ… 4æ®µéšŽã®ã€Œãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ«ãƒ¼ãƒˆã€ã§ã€çµ¶å¯¾å¾©å…ƒã§ãã‚‹ï¼š
ã‚¹ãƒ†ãƒƒãƒ—	å½¹å‰²	æ™‚é–“	ä¾‹ãˆã‚‹ãªã‚‰
â‘  ãƒ©ã‚¤ãƒˆãƒŽãƒ¼ãƒ‰å¾©å…ƒ	æœ¬å‘½	50ms	è²¡å¸ƒã‹ã‚‰ãŠé‡‘ã‚’å–ã‚Šå‡ºã™æ„Ÿè¦š
â‘¡ ãƒ•ãƒ«ãƒŽãƒ¼ãƒ‰å¾©å…ƒ	äºˆå‚™	100ms	éŠ€è¡Œã®ATMã§ä¸‹ã‚ã™æ„Ÿã˜
â‘¢ MongoDBå¾©å…ƒ	ä¿é™º	300ms	é€šå¸³ã‚’æŒã£ã¦éŠ€è¡Œçª“å£ã§èžãæ„Ÿã˜
â‘£ å¤§é™¸ãƒ«ãƒ¼ã‚¿ãƒ¼ï¼‹immuDBå¾©å…ƒ	æœ€çµ‚æ‰‹æ®µ	600ms	æœ¬åº—ã«é›»è©±ã—ã¦ç¢ºèªã™ã‚‹æ„Ÿã˜

