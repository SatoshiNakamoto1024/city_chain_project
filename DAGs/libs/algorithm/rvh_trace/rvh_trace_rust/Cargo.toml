# D:\city_chain_project\DAGs\libs\algorithm\rvh_trace\rvh_trace_rust\Cargo.toml
[package]
name        = "rvh_trace_rust"
version     = "0.1.0"
edition     = "2021"
description = "High-performance tracing and metrics helper (Rust core + PyO3 bindings)"
license     = "Apache-2.0"
repository  = "https://github.com/yourorg/rvh_trace"
build       = "build.rs"

[features]
# Python 拡張（拡張モジュール用のリンク設定のみ。）
python        = ["pyo3/extension-module", "pyo3/abi3-py312"]
py-ext    = ["pyo3/extension-module", "pyo3/abi3-py312"]
# 埋め込み動作用（必要なら）
py-embed  = ["pyo3/auto-initialize"]

# ── 純 Rust (デフォルト) ───────────────────────────────
default = ["core"]
core    = []
test    = []
cli     = []
embed-tests  = []     # ← もし後でテストを丸ごと切り替えたい場合用のスイッチ

[dependencies]
# --- runtime & tracing -----------------------------------------------------
tokio                   = { workspace = true, features = ["rt","rt-multi-thread","macros","time", "signal"] }
tracing         = { version = "0.1", features = ["log"] }
tracing-subscriber      = { version = "0.3", features = ["fmt", "json","env-filter","registry", "time"] }
tracing-opentelemetry   = "0.22"
once_cell               = "1.19"
prometheus      = "0.13"

# --- OpenTelemetry ---------------------------------------------------------
opentelemetry           = { version = "0.21", features = ["trace"] }
opentelemetry-otlp      = { version = "0.14", features = ["tonic"] }

# --- PyO3 & pyo3-asyncio (for Python ≥3.8 / Python 3.12 対応) ---------------
pyo3 = { workspace = true, default-features = false }   # ①一旦 feature を全部外す
pyo3-async-runtimes = { workspace = true }

# --- errors & CLI etc. ----------------------------------------------------
serde           = { version = "1.0", features = ["derive"] }
thiserror       = "1.0"
anyhow          = "1.0"
clap            = { version = "4.5", features = ["derive"] }
indoc           = "1"
chrono          = { version = "0.4", default-features = false, features = ["clock", "serde"] }
dashmap         = "5.5"
config          = "0.14"

[dev-dependencies]
tokio-test      = "0.4"
criterion       = { version = "0.5", features = ["html_reports","async_tokio"] }
predicates      = "3"
serde_json      = "1"
assert_cmd      = "2.0"
tempfile        = "3.10"
walkdir         = "2.5"
rayon           = "1.10"

[build-dependencies]
pyo3-build-config = "0.25"

# ===== ☆ 重要 ☆ =========================================
# これを書くだけで pyo3-build-config が自動でリンクフラグを伝搬
[package.metadata.pyo3]
extension-module = true

[lib]
name       = "rvh_trace_rust"
crate-type = ["cdylib", "rlib"]
path       = "src/lib.rs"

[[bin]]
name = "main_trace"
path = "src/main_trace.rs"

[[bench]]
name    = "bench_trace"
harness = false
path    = "benches/bench_trace.rs"

[[test]]
name = "test_py_bindings"
path = "tests/test_py_bindings.rs"
required-features = ["python"]